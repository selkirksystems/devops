---
# Based heavily on the Ansible documentation on EC2:
# http://docs.ansible.com/ec2_module.html
  - name: Provision an EC2 node
    hosts: localhost
    connection: local
    gather_facts: False
    vars:
      instance_type: t2.micro
      security_group: AWS-OpsWorks-Custom-Server
      image: ami-5189a661
      region: us-west-2a
      zone: a
      keypair: Selkirk-PK
    tasks:
      - name: Launch new Instance
        local_action: ec2 instance_tags='{"Name":"FMTdev - devweb","opsworks:instance":"devweb1","opsworks:layer:web1":"Web","opsworks:stack":"FMTdev"}' group={{ security_group }} instance_type={{ instance_type}} image={{ image }} wait=true aws_zone='{{ region }}{{ zone }}' keypair={{ keypair }}
        register: ec2

      - name: Output info about the instance
        debug: var=ec2

      - name: Wait for SSH to come up
        local_action: wait_for host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
        with_items: ec2.instances

#      - name: With the newly provisioned EC2 node configure that thing 
#        hosts: launched # This uses the hosts that we put into the in-memory hosts repository with the add_host module.
#        sudo: yes # On EC2 nodes, this is automatically passwordless. 
#        remote_user: ubuntu # This is the username for all ubuntu images, rather than root, or something weird.
#        gather_facts: True  #We need to re-enable this, as we turned it off earlier.
#        roles:
#          - common

